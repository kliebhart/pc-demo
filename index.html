<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>Demo | Red Bull Policy Center</title>


    <script>
  window.dataLayer = window.dataLayer || [];
  window.rb_cookieconsent_options = {
    "projectshortname": "RedBull.com_International",
    "baseurl":  		    "https://policies-design.redbull.com",
    "contextpath": 		  "/rbcookieconsent",
    "messagepath":      "/r/",
    "version":			    "2.3.0",
    "theme": 			      "white",
    "language":  		    "en",
    "region": 			    "AT",
    "updatedate":   	  "2018-06-10",
    "ishard":			      "false",
    "container":    "#cookie-banner"
  }
    </script>
    <!-- Redirect Service URL -->
    <!-- <script src="https://policies-design.redbull.com/rbcookieconsent/2/cookieconsent.min.js" type="text/javascript"></script> -->

    <!-- Latest Version -->
    <!-- <script src="https://policies-design.redbull.com/rbcookieconsent/2.4.2/cookieconsent.min.js" type="text/javascript"></script> -->

    <!-- Forms API UIM -->
    <script src="https://uim.redbull.com/static/uim-web-sdk/3.5/uimWebSdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.5/require.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script>

  demoApp = {};
  var uimWebSdk = null;

  var cleanForm = function(formElement) {
    formElement.innerHtml = "";
    while(formElement.firstChild){
       formElement.removeChild(formElement.firstChild);
    }
  }

  var renderPolicyElements = function (policiesRendering, formId) {
     var formElement = document.getElementById(formId);
     cleanForm(formElement);
     for (var i = 0; i < policiesRendering.length; i++) {
       var div = document.createElement('div');
       div.setAttribute('class', 'mui-checkbox');
       var checkbox = document.createElement('input');
       checkbox.setAttribute('type', 'checkbox');
       checkbox.setAttribute('id', policiesRendering[i].ids.join('_and_'));
       if (!policiesRendering[i].checkbox) {
         checkbox.setAttribute('hidden', true);
         checkbox.setAttribute('checked', true);
       }
       div.appendChild(checkbox);
       var label = document.createElement('label');
       label.innerHTML = policiesRendering[i].text;
       div.appendChild(label);
       formElement.appendChild(div);
     }
   };

   var renderNewsletterElements = function (newsletters, formId) {
     var formElement = document.getElementById(formId);
     cleanForm(formElement);
     for (var i = 0; i < newsletters.length; i++) {
       var div = document.createElement('div');
       div.setAttribute('class', 'mui-checkbox');
       var checkbox = document.createElement('input');
       checkbox.setAttribute('type', 'checkbox');
       checkbox.setAttribute('id', newsletters[i].id);
       div.appendChild(checkbox);
       var label = document.createElement('label');
       label.innerHTML = newsletters[i].text;
       div.appendChild(label);
       formElement.appendChild(div);
     }
   };


   var workflowErrorCallback = function (error) {
     reload(error.message);
   };

   var errorHandler = function (error) {
         console.log(error);
   };

   var changeSettings = function () {
	   initUIM();
   };

   var changeFormItems = function(baseUrl) {

     var lang = document.getElementById("language").value;
     var country = document.getElementById("country").value;
     var formAlias = document.getElementById("formAlias").value;
     var formUrl =  baseUrl + "/api/forms/" + formAlias + "/items?language="+lang+"&country="+country;
	 var sdkVersion = "v14";
     var acceptHeader = "application/vnd.rb.uim-" + sdkVersion + "+json";

     console.log("Getting formItems using country: " + country + ", language: " + lang + ", acceptHeader " + acceptHeader + " and URL: " + formUrl);

     $.ajax({
       url: formUrl,
       headers: {
                  "Accept": acceptHeader
                },
       success: function(r) {
          console.log("Received formDefinition: " + r);
          renderPolicyElements(r.policyRenderings, "formPoliciesDiv");
          renderNewsletterElements(r.newsletters, "formNewslettersDiv");
       }
     });

   };

   var changeRegistrationItems = function(uimApi) {
     uimApi.getRegistrationItems().then(function (registrationItems) {
         renderPolicyElements(registrationItems.policiesRendering, 'registerPoliciesDiv');
         renderNewsletterElements(registrationItems.newsletters, 'registerNewslettersDiv');
      }).catch(errorHandler);
   };

   var initUIM = function() {

	 var env = "design";
     var appId = document.getElementById("applicationId").value;
     var lang = document.getElementById("language").value;
     var country = document.getElementById("country").value;
     console.log("Initialising UIM with appId: " + appId + ", env: " + env + ", lang: " + lang + ", and country: " + country);

     var uimApiPromise = uimWebSdk
       .setupUimApi()
       .withEnvironment(env)
       .withApplicationId(appId)
       .withCountry(country)
       .withLanguage(lang)
       .onNewMandatoryInformation(errorHandler)
       .onNewPasswordRequired(errorHandler)
       .onWorkflowError(workflowErrorCallback).initialize();

     uimApiPromise.then(function (uimApi) {
       changeRegistrationItems(uimApi);
       changeFormItems(uimApi.options.server);

     }).catch(errorHandler);


   };


   require(['@uim/web-sdk'], function (uimWebSdkParam) {
         uimWebSdk = uimWebSdkParam;
         initUIM();
   });

  </script>
</head>
<body>

<form id="appParams">

    ApplicationId: <input type="text" id="applicationId" value="5846b243958b0b3fb6b1908e"></input>
    <br/>
    Language: <input type="text" id="language" value="en"></input>
    <br/>
    Country: <input type="text" id="country" value="ZZ"></input>
    <br/>
    FormAlias: <input type="text" id="formAlias" value="rb3_newsletter_subscription"></input>
    <br/>

    <button type="button" class="mui-btn mui-btn--raised mui-btn--primary"
            onclick="changeSettings()">Change Settings
    </button>

</form>

<form id="registerForm" class="mui-form">
    <h2>Registration Items</h2>
    <h2>Form Items</h2>
    <div id="formPoliciesDiv"></div>
    <br/>
    <div id="formNewslettersDiv"></div>
</form>

</body>
</html>